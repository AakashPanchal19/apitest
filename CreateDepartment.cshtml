@model BOBDrive.ViewModels.Admin.DepartmentBulkHierarchyViewModel
@using BOBDrive.Models
@using BOBDrive.ViewModels.Admin
@{
    ViewBag.Title = "Create Department Hierarchy";
    Layout = "~/Views/Shared/_Layout.cshtml";

    var extensions = ViewBag.AvailableExtensions as IEnumerable<AllowedFileExtension> ?? Enumerable.Empty<AllowedFileExtension>();
    var defaults = ViewBag.Defaults as DepartmentDefaultsViewModel ?? new DepartmentDefaultsViewModel();
}
<style>
/* layout & styles (refined - buttons moved to absolute right so they don't push node width) */
.dept-flex-row{display:flex;flex-wrap:wrap;gap:20px;margin-bottom:18px}
.dept-flex-col{background:#fff;border-radius:10px;flex:1 1 360px;min-width:300px;min-height:420px;padding:18px;box-shadow:0 6px 18px rgba(18,35,58,0.04);border:1px solid rgba(15,40,62,0.04)}
@@media(max-width:1000px){.dept-flex-row{flex-direction:column;gap:12px}}
#hierarchy-tree-outer{max-height:360px;min-height:140px;overflow-y:auto;padding:10px;border-radius:8px;border:1px solid #eef2f6;background:linear-gradient(180deg,#fff,#fbfdff)}
.hierarchy-list{list-style:none;padding-left:18px;margin:0}
.hierarchy-node{margin:6px 0;padding:10px;border-radius:8px;background:#fff;border:1px solid #eef3f8;box-shadow:0 2px 6px rgba(12,30,50,0.02);position:relative;overflow:visible}
.hierarchy-node.root-node{border-left:4px solid #06a6c9;background:#f0fbfd}
.hierarchy-node.child-node{border-left:4px solid #36b24a;background:#f1fbf2}
.hierarchy-node-header{display:flex;gap:10px;align-items:center;justify-content:flex-start}
.hierarchy-node-title{flex:1 1 auto;margin-right:8px;position:relative;padding-right:150px} /* pad right to avoid overlap with absolute actions */
.hierarchy-node-title input[type="text"]{width:100%;border:none;background:transparent;border-bottom:1px dashed rgba(75,120,160,.18);padding:6px;font-size:14px;border-radius:4px}
.hierarchy-node-title input[type="text"]:focus{outline:none;background:#f0fcfd;box-shadow:0 0 0 3px rgba(6,166,201,0.06)}
/* actions positioned to the right, absolute so they don't change layout */
.hierarchy-node-actions{position:absolute;right:12px;top:10px;display:flex;gap:6px;white-space:nowrap}
.hierarchy-node-actions .btn { padding:5px 8px; font-size:12px; border-radius:6px; display:inline-flex; align-items:center; gap:6px; line-height:1 }
.hierarchy-node-actions .btn .btn-label { display:inline-block; max-width:80px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; font-size:12px; }
/* hide full labels on very small widths (keeps buttons compact) */
@@media (max-width:520px){ .hierarchy-node-actions .btn .btn-label{ display:none } }
.children-container{margin-top:8px;padding-left:14px;border-left:1px dashed rgba(120,150,180,.08)}
/* suggestion box */
.suggest-box{position:absolute;z-index:1300;background:#fff;border:1px solid #dfe7ef;border-radius:6px;box-shadow:0 8px 24px rgba(10,20,30,0.08);max-height:220px;overflow-y:auto;min-width:220px}
.suggest-item{padding:8px 10px;cursor:pointer;font-size:14px;color:#112}
.suggest-item:hover{background:#f0fbff}
.suggest-add{padding:8px 10px;cursor:pointer;color:#0a6;font-weight:600;border-top:1px dashed #eee}

/* toolbar buttons spacing */
#hierarchy-toolbar .btn { margin-right:8px; }

/* defaults panel tweaks */
.defaults-panel h4, .defaults-panel h5 { margin-top:0; margin-bottom:8px; color:#233040; }
.defaults-panel .checkbox { margin-bottom:10px; }
.defaults-panel small { color:#6b7280; }

/* select2 fallback: ensure select looks tidy when not initialized */
#extensions-select { min-height: 36px; padding:6px; border-radius:4px; border:1px solid #dfe6ee; background:#fff; }
</style>

<h2>Create Department Hierarchy</h2>

@if (!ViewData.ModelState.IsValid)
{
    <div class="alert alert-danger">
        @foreach (var err in ViewData.ModelState.Values.SelectMany(v => v.Errors))
        {
            if (!string.IsNullOrWhiteSpace(err.ErrorMessage))
            {
                <div>@err.ErrorMessage</div>
            }
        }
    </div>
}

<p class="text-muted">Build the department tree using the controls. Names are suggested from a catalog; unknown names can be added to the catalog automatically.</p>

@using (Html.BeginForm("CreateDepartment", "AdminDashboard", FormMethod.Post, new { autocomplete = "off", onsubmit = "prepareHierarchyJson();" }))
{
    @Html.AntiForgeryToken()
    <input type="hidden" id="HierarchyJson" name="HierarchyJson" />

    <div class="dept-flex-row">
        <div class="dept-flex-col" style="flex:2 1 520px;">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
                <div id="hierarchy-toolbar">
                    <button type="button" class="btn btn-outline-info btn-sm" onclick="addRootNode();">+ Top Level</button>
                    <button type="button" class="btn btn-outline-default btn-sm" onclick="expandAll();">&#9660; Expand</button>
                    <button type="button" class="btn btn-outline-default btn-sm" onclick="collapseAll();">&#9650; Collapse</button>
                </div>
                <div style="font-size:13px;color:#4b5563">
                    <span style="margin-right:12px"><span style="display:inline-block;width:12px;height:12px;background:#e6f7fb;border-radius:2px;margin-right:6px;border:1px solid #9fdbe8"></span>Top-level</span>
                    <span><span style="display:inline-block;width:12px;height:12px;background:#e8f7ec;border-radius:2px;margin-right:6px;border:1px solid #8dd690"></span>Sub/Team</span>
                </div>
            </div>

            <div id="hierarchy-tree-outer">
                <div id="hierarchy-tree-wrapper">
                    <ul id="hierarchy-root" class="hierarchy-list"></ul>
                </div>
            </div>

            <div style="margin-top:12px;font-size:13px;color:#6b7280">
                Tip: Click a node to edit name. Suggestions will appear while typing. Use Add Child (green) / Add Sibling (blue).
            </div>
        </div>

        <div class="dept-flex-col defaults-panel" style="flex:1 1 320px;">
            <h4>Default Policies</h4>
            <div style="display:flex;gap:8px;margin-bottom:8px">
                <div style="flex:1">
                    <div class="checkbox"><label>@Html.CheckBox("defaults.IsVisibilityAllowed", defaults.IsVisibilityAllowed) Visibility</label></div>
                    <div class="checkbox"><label>@Html.CheckBox("defaults.IsDownloadingAllowed", defaults.IsDownloadingAllowed) Download</label></div>
                    <div class="checkbox"><label>@Html.CheckBox("defaults.IsZippingAllowed", defaults.IsZippingAllowed) Zipping</label></div>
                </div>
                <div style="flex:1">
                    <div class="checkbox"><label>@Html.CheckBox("defaults.IsCopyFromOtherDriveAllowed", defaults.IsCopyFromOtherDriveAllowed) Copy</label></div>
                    <div class="checkbox"><label>@Html.CheckBox("defaults.IsSharingAllowed", defaults.IsSharingAllowed) Internal Share</label></div>
                    <div class="checkbox"><label>@Html.CheckBox("defaults.IsExternalSharingAllowed", defaults.IsExternalSharingAllowed) External Share</label></div>
                </div>
            </div>

            <hr />

            <h5>Default Allowed Extensions</h5>
            <select id="extensions-select" name="defaults.ExtensionIds" multiple="multiple" style="width:100%" required>
                @foreach (var ext in extensions)
                {
                    var selected = defaults.ExtensionIds != null && defaults.ExtensionIds.Contains(ext.Id);
                    <option value="@ext.Id" @(selected ? "selected=\"selected\"" : "")>@ext.Extension</option>
                }
            </select>
            <small>Type to search, Ctrl+click to select many. Leave empty = no extensions.</small>
        </div>
    </div>

    <div class="form-actions-row">
        <button type="submit" class="btn btn-primary">Create Departments</button>
        <a href="@Url.Action("Departments", "AdminDashboard")" class="btn btn-default" style="margin-left:8px">Cancel</a>
    </div>
}

@section scripts{
    <link href="@Url.Content("~/Content/select2.min.css")" rel="stylesheet" />
    <script src="@Url.Content("~/Scripts/select2.min.js")"></script>

    <script>
    (function () {
        // create suggestion box element
        var suggestBox = document.createElement('div');
        suggestBox.className = 'suggest-box';
        suggestBox.style.display = 'none';
        document.body.appendChild(suggestBox);

        function showSuggest(input, items) {
            var rect = input.getBoundingClientRect();
            suggestBox.style.left = (window.pageXOffset + rect.left) + 'px';
            suggestBox.style.top = (window.pageYOffset + rect.bottom + 6) + 'px';
            suggestBox.style.minWidth = Math.max(220, rect.width) + 'px';
            suggestBox.innerHTML = '';
            if (!items || items.length === 0) {
                var addDiv = document.createElement('div');
                addDiv.className = 'suggest-add';
                addDiv.textContent = "Add '" + input.value.trim() + "' to catalog";
                addDiv.onclick = function () { addDepartmentName(input.value.trim(), function (res) { if (res && res.success) { input.value = res.name; hideSuggest(); } else alert(res && res.message ? res.message : 'Could not add'); }); };
                suggestBox.appendChild(addDiv);
            } else {
                items.forEach(function (it) {
                    var div = document.createElement('div');
                    div.className = 'suggest-item';
                    div.textContent = it;
                    div.onclick = function () { input.value = it; hideSuggest(); };
                    suggestBox.appendChild(div);
                });
                var addDiv = document.createElement('div');
                addDiv.className = 'suggest-add';
                addDiv.textContent = "Add '" + input.value.trim() + "' to catalog";
                addDiv.onclick = function () { addDepartmentName(input.value.trim(), function (res) { if (res && res.success) { input.value = res.name; hideSuggest(); } else alert(res && res.message ? res.message : 'Could not add'); }); };
                suggestBox.appendChild(addDiv);
            }
            suggestBox.style.display = 'block';
        }
        function hideSuggest() { suggestBox.style.display = 'none'; }

        function debounce(fn, wait) { var t; return function () { var args = arguments, ctx = this; clearTimeout(t); t = setTimeout(function () { fn.apply(ctx, args); }, wait); }; }

        function fetchSuggestions(q, cb) {
            if (!q || q.length < 1) { cb([]); return; }
            var xhr = new XMLHttpRequest();
            xhr.open('GET', '@Url.Action("DepartmentNameSuggestions","AdminDashboard")?q=' + encodeURIComponent(q), true);
            xhr.onreadystatechange = function () {
                if (xhr.readyState === 4) {
                    if (xhr.status === 200) {
                        try { var json = JSON.parse(xhr.responseText); cb(json || []); } catch (e) { cb([]); }
                    } else cb([]);
                }
            };
            xhr.send();
        }

        function addDepartmentName(name, cb) {
            var xhr = new XMLHttpRequest();
            xhr.open('POST', '@Url.Action("AddDepartmentName","AdminDashboard")', true);
            xhr.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded; charset=UTF-8');
            var tokenEl = document.querySelector('input[name="__RequestVerificationToken"]');
            var token = tokenEl ? tokenEl.value : '';
            xhr.onreadystatechange = function () {
                if (xhr.readyState === 4) {
                    try { var json = JSON.parse(xhr.responseText); cb(json); } catch (e) { cb(null); }
                }
            };
            xhr.send('name=' + encodeURIComponent(name) + '&__RequestVerificationToken=' + encodeURIComponent(token));
        }

        // attach suggestion behavior to an input
        function attachSuggest(input) {
            if (!input || input.dataset.suggestAttached) return;
            input.dataset.suggestAttached = '1';
            var deb = debounce(function () {
                var q = input.value.trim();
                if (q.length === 0) { hideSuggest(); return; }
                fetchSuggestions(q, function (items) { showSuggest(input, items); });
            }, 220);
            input.addEventListener('input', deb);
            input.addEventListener('focus', function () { var q = input.value.trim(); if (q.length > 0) fetchSuggestions(q, function (items) { showSuggest(input, items); }); });
            input.addEventListener('blur', function () { setTimeout(hideSuggest, 200); });
        }

        // Tree builder functions with actions positioned absolute (so alignment stable)
        var rootList = document.getElementById('hierarchy-root');
        var nodeIdCounter = 0;

        function createNodeElement(name, isRoot) {
            nodeIdCounter++;
            var li = document.createElement('li');
            li.className = 'hierarchy-node ' + (isRoot ? 'root-node' : 'child-node');

            var header = document.createElement('div'); header.className = 'hierarchy-node-header';
            var left = document.createElement('div'); left.style.display = 'flex'; left.style.alignItems = 'center'; left.style.flex = '1';

            var toggleBtn = document.createElement('button'); toggleBtn.type = 'button'; toggleBtn.className = 'btn btn-xs btn-default toggle-children-btn'; toggleBtn.textContent = '-';
            toggleBtn.title = 'Show/hide children';
            toggleBtn.onclick = function () { toggleChildren(li, toggleBtn); };

            var titleDiv = document.createElement('div'); titleDiv.className = 'hierarchy-node-title';
            var input = document.createElement('input'); input.type = 'text'; input.value = name || ''; input.placeholder = isRoot ? "Top-level Department" : "Sub Department"; input.autocomplete = 'off'; input.required = true; input.spellcheck = false;

            titleDiv.appendChild(input); left.appendChild(toggleBtn); left.appendChild(titleDiv);

            var actions = document.createElement('div'); actions.className = 'hierarchy-node-actions';
            var addChildBtn = document.createElement('button'); addChildBtn.type = 'button'; addChildBtn.className = 'btn btn-xs btn-success'; addChildBtn.innerHTML = '＋ <span class="btn-label">Child</span>'; addChildBtn.title = 'Add child'; addChildBtn.onclick = function () { addChildNode(li); };
            var addSiblingBtn = document.createElement('button'); addSiblingBtn.type = 'button'; addSiblingBtn.className = 'btn btn-xs btn-info'; addSiblingBtn.innerHTML = '＋ <span class="btn-label">Sibling</span>'; addSiblingBtn.title = 'Add sibling'; addSiblingBtn.onclick = function () { addSiblingNode(li); };
            var removeBtn = document.createElement('button'); removeBtn.type = 'button'; removeBtn.className = 'btn btn-xs btn-danger'; removeBtn.innerHTML = '✕ <span class="btn-label">Remove</span>'; removeBtn.title = 'Remove'; removeBtn.onclick = function () { removeNode(li); };

            actions.appendChild(addChildBtn); actions.appendChild(addSiblingBtn); actions.appendChild(removeBtn);

            header.appendChild(left); header.appendChild(actions);

            var children = document.createElement('ul'); children.className = 'hierarchy-list children-container';
            li.appendChild(header); li.appendChild(children);

            // attach suggestion to new input
            attachSuggest(input);

            setTimeout(function () { input.focus(); }, 10);
            return li;
        }

        function addRootNode() { var n = createNodeElement('', true); rootList.appendChild(n); }
        function addChildNode(parentLi) { var c = parentLi.querySelector('.children-container'); if (!c) return; c.appendChild(createNodeElement('', false)); }
        function addSiblingNode(li) { var p = li.parentNode; if (!p) return; var isRoot = (p === rootList); p.insertBefore(createNodeElement('', isRoot), li.nextSibling); }
        function removeNode(li) { if (!li) return; var p = li.parentNode; if (!p) return; p.removeChild(li); }
        function toggleChildren(li, btn) { var c = li.querySelector('.children-container'); if (!c) return; if (c.style.display === 'none') { c.style.display = ''; btn.textContent = '-'; } else { c.style.display = 'none'; btn.textContent = '+'; } }

        window.expandAll = function () { var lists = rootList.querySelectorAll('.children-container'); for (var i = 0; i < lists.length; i++) lists[i].style.display = ''; var toggles = rootList.querySelectorAll('.toggle-children-btn'); for (var j = 0; j < toggles.length; j++) toggles[j].textContent = '-'; };
        window.collapseAll = function () { var lists = rootList.querySelectorAll('.children-container'); for (var i = 0; i < lists.length; i++) if (lists[i].children.length > 0) lists[i].style.display = 'none'; var toggles = rootList.querySelectorAll('.toggle-children-btn'); for (var j = 0; j < toggles.length; j++) toggles[j].textContent = '+'; };

        window.prepareHierarchyJson = function () {
            var jsonField = document.getElementById('HierarchyJson');
            if (!jsonField) return;
            function buildNode(li, parentPath) {
                var input = li.querySelector('.hierarchy-node-title input');
                if (!input) return null;
                var name = input.value.trim();
                if (!name) return null;
                var fullPath = parentPath ? parentPath + ' > ' + name : name;
                var item = { name: name, path: fullPath, children: [] };
                var children = li.querySelector('.children-container');
                if (children) {
                    var childLis = children.children;
                    for (var i = 0; i < childLis.length; i++) {
                        var childNode = buildNode(childLis[i], fullPath);
                        if (childNode) item.children.push(childNode);
                    }
                }
                return item;
            }
            var result = [];
            var roots = rootList.children;
            for (var i = 0; i < roots.length; i++) {
                var node = buildNode(roots[i], '');
                if (node) result.push(node);
            }
            jsonField.value = JSON.stringify(result);
        };

        // ensure initial root exists
        if (rootList.children.length === 0) addRootNode();

        // init select2 if available (local)
        try {
            if (window.jQuery && $.fn.select2) {
                $('#extensions-select').select2({ placeholder: "Select allowed extensions...", width: '100%', allowClear: true });
            }
        } catch (e) { console && console.warn && console.warn(e); }

    })();
    </script>
}