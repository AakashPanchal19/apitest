@*
    Layout with role-aware navigation:
    - Shows admin links only to Admin users.
    - Shows Monitor Dashboard link only to users who are data monitors of any department.
    - Keeps picker security and logout-preservation scripts unchanged.
*@
@using BOBDrive.Models
@using System.Linq

<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>@ViewBag.Title - BOB Drive</title>
    @Styles.Render("~/Content/css")
    @Scripts.Render("~/bundles/modernizr")

    <script type="text/javascript">
        // Picker security guard (unchanged)
        (function () {
            var sessionKey = 'isBobDrivePickerPopup';
            try {
                var params = new URLSearchParams(window.location.search);
                var isPickerUrl = params.get('picker') === 'true';
                if (isPickerUrl && window.opener) {
                    sessionStorage.setItem(sessionKey, 'true');
                }
                var isLegitPickerSession = sessionStorage.getItem(sessionKey) === 'true';
                if (isPickerUrl && !isLegitPickerSession) {
                    params.delete('picker');
                    var queryString = params.toString();
                    var newUrl = window.location.pathname + (queryString ? '?' + queryString : '');
                    window.location.replace(newUrl);
                }
            } catch (e) {
                console.error("Picker security check failed:", e);
            }
        })();
    </script>

    <style>
        /* Global loading overlay - modern, multi-dot animation */
        #globalLoadingOverlay {
            display: none;
            position: fixed;
            inset: 0;
            background: radial-gradient(circle at top, rgba(255,255,255,0.92), rgba(240,240,240,0.98));
            z-index: 50000;
            align-items: center;
            justify-content: center;
            backdrop-filter: blur(2px);
        }

        #globalLoadingOverlay .gl-box {
            background: rgba(255,255,255,0.97);
            border-radius: 10px;
            padding: 16px 22px 14px;
            box-shadow: 0 12px 30px rgba(0,0,0,0.18);
            display: inline-flex;
            flex-direction: column;
            align-items: center;
            min-width: 210px;
            animation: gl-popin 160ms ease-out;
        }

        #globalLoadingOverlay .gl-spinner {
            display: flex;
            gap: 8px;
            margin-bottom: 8px;
        }

        #globalLoadingOverlay .gl-dot {
            width: 10px;
            height: 10px;
            border-radius: 999px;
            background: linear-gradient(135deg, #0078d4, #00b4ff);
            box-shadow: 0 0 8px rgba(0,120,212,0.45);
            animation: gl-pulse 1.1s infinite ease-in-out;
        }

        #globalLoadingOverlay .gl-dot-2 {
            animation-delay: 0.15s;
        }

        #globalLoadingOverlay .gl-dot-3 {
            animation-delay: 0.30s;
        }

        #globalLoadingOverlay .gl-text {
            font-size: 13px;
            color: #333;
            letter-spacing: 0.02em;
        }

        @@keyframes gl-pulse {
            0%, 80%, 100% {
                transform: scale(0.8);
                opacity: 0.4;
            }
            40% {
                transform: scale(1.2);
                opacity: 1;
            }
        }

        @@keyframes gl-popin {
            from {
                opacity: 0;
                transform: translateY(4px) scale(0.96);
            }
            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }
    </style>
</head>
<body class="@(ViewBag.IsPickerMode == true ? "picker-mode" : "")">

    @* IMPORTANT: Do NOT render _LoginPartial here (outside the navbar). *@

    <nav class="navbar navbar-inverse navbar-fixed-top" role="navigation">
        <div class="container">
            <div class="navbar-header">
                @* Mobile toggle button for collapsed navbar *@
                <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#topNavbar">
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                </button>

                @if (ViewBag.IsPickerMode == false)
                {
                    @Html.ActionLink("BOB Drive", "Index", "Home", new { area = "" }, new { @class = "navbar-brand" })
                }
            </div>

            <div class="collapse navbar-collapse" id="topNavbar">
                @* LEFT SIDE NAV LINKS (role-aware) *@
                <ul class="nav navbar-nav">
                    @if (Request.IsAuthenticated)
                    {
                        // Common link for any logged-in user
                        <li>@Html.ActionLink("Home", "Index", "Home")</li>

                        // Inspect current user for role & monitor status
                        var isAdmin = false;
                        var showMonitorDashboard = false;

                        try
                        {
                            using (var db = new CloudStorageDbContext())
                            {
                                var externalId = User.Identity.Name;
                                var currentUser = db.Users.FirstOrDefault(u => u.ExternalUserId == externalId);
                                if (currentUser != null)
                                {
                                    isAdmin = currentUser.Role == UserRoles.Admin;

                                    // Monitor: data monitor of any department
                                    showMonitorDashboard = db.Departments
                                        .Any(d => d.DataMonitorUserId == currentUser.Id);
                                }
                            }
                        }
                        catch
                        {
                            // Do not break layout if DB is unavailable
                            isAdmin = false;
                            showMonitorDashboard = false;
                        }

                        // Admin-only navigation
                        if (isAdmin)
                        {
                            @* Admin dashboard main *@
                            <li>@Html.ActionLink("Admin Dashboard", "Index", "AdminDashboard")</li>

                            @* Example admin links – adjust to match your existing menu *@
                            <li>@Html.ActionLink("Users", "Users", "AdminDashboard")</li>
                            <li>@Html.ActionLink("Departments", "Departments", "AdminDashboard")</li>
                            <li>@Html.ActionLink("System Settings", "SystemSettings", "AdminDashboard")</li>
                            <li>@Html.ActionLink("Client Apps", "ClientApplications", "AdminDashboard")</li>
                        }

                        // Data Monitor dashboard (for monitors, including admins if they are also monitors)
                        if (showMonitorDashboard)
                        {
                            <li>@Html.ActionLink("Monitor Dashboard", "Index", "MonitorDashboard")</li>
                        }
                    }
                </ul>

                @* RIGHT SIDE: Login / User links from your existing partial *@
                @Html.Partial("_LoginPartial")
            </div>
        </div>
    </nav>

    <div class="container body-content" style="padding-top: 60px;">
        @if (TempData["SuccessMessage"] != null)
        {
            <div class="alert alert-success">@TempData["SuccessMessage"]</div>
        }
        @if (TempData["ErrorMessage"] != null)
        {
            <div class="alert alert-danger">@TempData["ErrorMessage"]</div>
        }

        @RenderBody()
        <hr />
        <footer>
            <p>&copy; @DateTime.Now.Year - Bank of Baroda Drive (Made In Datawarehouse)</p>
        </footer>
    </div>

    @Scripts.Render("~/bundles/jquery")
    @Scripts.Render("~/bundles/bootstrap")

    @Scripts.Render("~/bundles/realtime")
    <script src="@Url.Content("~/signalr/hubs")"></script>
    <script type="text/javascript">
        (function () {
            if (!window.jQuery || !$.connection) return;

            var userId = '@(User.Identity.IsAuthenticated ? User.Identity.Name : "")';
            if (!userId) return;

            var userHub = $.connection.userSessionHub;
            if (!userHub) return;

            // Called by server when user must be logged out
            userHub.client.forceLogout = function (reason) {
                try {
                    // Clear any local picker flag to avoid re‑entering restricted context.
                    try { sessionStorage.removeItem('isBobDrivePickerPopup'); } catch (e) { }

                    alert(reason || "You have been signed out.");

                    // Post hidden-logout form if available, else hard redirect to /Account/Logout
                    var frm = document.getElementById('logoutForm');
                    if (frm) {
                        // Ensure we don't send isPicker=true here
                        var input = frm.querySelector('input[name="isPicker"]');
                        if (input) { input.parentNode.removeChild(input); }
                        frm.submit();
                    } else {
                        window.location.href = '@Url.Action("Logout","Account")';
                    }
                } catch (e) {
                    console.error("Force logout handler failed:", e);
                    window.location.href = '@Url.Action("Logout","Account")';
                }
            };

            $.connection.hub.start().done(function () {
                try {
                    userHub.server.registerUserConnection(userId);
                } catch (e) {
                    console.error("Failed to register user connection:", e);
                }
            });
        })();
    </script>

    @RenderSection("scripts", required: false)

    <script type="text/javascript">
        // Preserve picker state on logout (unchanged)
        $(document).ready(function () {
            var sessionKey = 'isBobDrivePickerPopup';
            if (sessionStorage.getItem(sessionKey) === 'true') {
                var logoutForm = $('#logoutForm');
                if (logoutForm.length) {
                    logoutForm.append('<input type="hidden" name="isPicker" value="true" />');
                }
            }
        });
    </script>

    <!-- New global loading overlay -->
    <div id="globalLoadingOverlay">
        <div class="gl-box">
            <div class="gl-spinner">
                <div class="gl-dot gl-dot-1"></div>
                <div class="gl-dot gl-dot-2"></div>
                <div class="gl-dot gl-dot-3"></div>
            </div>
            <div class="gl-text">Please wait...</div>
        </div>
    </div>

    <script type="text/javascript">
        // GlobalLoading helper (API unchanged)
        window.GlobalLoading = (function () {
            function ensure() {
                var $ov = $('#globalLoadingOverlay');
                if (!$ov.length) {
                    $('body').append(
                        '<div id="globalLoadingOverlay">' +
                        '  <div class="gl-box">' +
                        '    <div class="gl-spinner">' +
                        '      <div class="gl-dot gl-dot-1"></div>' +
                        '      <div class="gl-dot gl-dot-2"></div>' +
                        '      <div class="gl-dot gl-dot-3"></div>' +
                        '    </div>' +
                        '    <div class="gl-text">Please wait...</div>' +
                        '  </div>' +
                        '</div>');
                    $ov = $('#globalLoadingOverlay');
                }
                return $ov;
            }
            return {
                show: function (text) {
                    var $ov = ensure();
                    if (text) {
                        $ov.find('.gl-text').text(text);
                    }
                    $ov.css('display', 'flex');
                },
                hide: function () {
                    ensure().hide();
                }
            };
        })();
    </script>

</body>
</html>